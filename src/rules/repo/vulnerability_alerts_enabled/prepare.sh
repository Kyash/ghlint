#!/bin/false
# shellcheck shell=bash

# shellcheck source=./src//http.sh
source "http.sh"
# shellcheck source=./src/jq.sh
source "jq.sh"
# shellcheck source=./src/github.sh
source "github.sh"

function rules::repo::vulnerability_alerts_enabled::prepare() {
  local resources_dump
  resources_dump="$(mktemp)"
  tee "$resources_dump" | jq -r '.resources.repositories | map([(. | tojson), "\(.url)/vulnerability-alerts"] | @tsv) | .[]' |
  while IFS=$'\t' read -r repo url
  do
    {
      github::fetch "${url}" -H 'Accept: application/vnd.github.dorian-preview+json' || {
        local exit_status="$?"
        echo 'false' | http::default_response "$exit_status"
      }
    } |
      jq -s '[.[0], { "vulnerability-alerts": { enable: (.[1] == null) } }] | add | { resources: { repositories: [.] } }' \
        <(echo "$repo") <(cat)
  done 
}
