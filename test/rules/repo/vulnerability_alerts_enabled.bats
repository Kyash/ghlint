#!/usr/bin/env bats

setup() {
  PATH="$BATS_TEST_DIRNAME/../../../src:$PATH"
  load "../../../src/rules.sh"
  rules::declare
  cd "$(mktemp -d)"
  function github::fetch() {
    return 22
  }
}

@test "rules::repo::vulnerability_alerts_enabled describe" {
  rules::repo::vulnerability_alerts_enabled describe |
    jq -e '.signature == "rules::repo::vulnerability_alerts_enabled"'
}

@test "rules::repo::vulnerability_alerts_enabled analyze" {
  local configure_dump
  configure_dump="$(mktemp)"
  jq -nr '{}' \
    >"$configure_dump"

  local resources_dump
  resources_dump="$(mktemp)"
  jq -n '{ name: "ghlint", url: "https://api.github.com/repos/Kyash/ghlint" }' |
    jq '{ resources: { repositories: [.] } }' \
    >"$resources_dump"

  run rules::repo::vulnerability_alerts_enabled analyze "$(cat "$configure_dump")" <"$resources_dump"
  declare -p status output >&2 || :
  test "$status" -eq 1
  jq -ne --argjson output "$output" '$output | .signature == "rules::repo::vulnerability_alerts_enabled"'
}
